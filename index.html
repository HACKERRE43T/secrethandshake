<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Right Sonic Receiver v3.0 (Robust)</title>
    <style>
        body { background: #111; color: #0f0; font-family: 'Courier New', monospace; text-align: center; }
        #monitor { border: 2px solid #0f0; width: 80%; margin: 20px auto; padding: 20px; min-height: 100px; font-size: 2em; background: #000; word-wrap: break-word; }
        #status { color: #fff; margin-bottom: 10px; }
        .btn { padding: 15px 30px; font-size: 1.2em; background: #0f0; color: #000; border: none; cursor: pointer; font-weight: bold; }
        #debug { font-size: 0.8em; color: #555; margin-top: 20px; }
    </style>
</head>
<body>

    <h1>ðŸ“¡ Right Sonic Receiver v3.0</h1>
    <div id="status">Microphone: OFF</div>
    <button class="btn" onclick="startListening()">START LISTENING</button>
    
    <div id="monitor">Waiting for Signal...</div>
    <div id="debug">Debug Info will appear here...</div>

    <script>
        // CONFIGURATION (Must match Python)
        const BASE_FREQ = 2000;
        const STEP_FREQ = 100;
        const HANDSHAKE_FREQ = 5000;
        const END_FREQ = 5500;
        const TOLERANCE = 40; // Hz +/- allowed error

        let audioCtx, analyser, microphone;
        let isListening = false;
        let messageBuffer = "";
        let lastChar = "";
        let consecutiveHits = 0;

        async function startListening() {
            try {
                audioCtx = new (window.AudioContext || window.webkitAudioContext)();
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                microphone = audioCtx.createMediaStreamSource(stream);
                analyser = audioCtx.createAnalyser();
                
                // Higher FFT size = Better Frequency Resolution (Key for accuracy)
                analyser.fftSize = 4096; 
                
                microphone.connect(analyser);
                isListening = true;
                document.getElementById('status').innerText = "Microphone: ON | Listening...";
                document.getElementById('monitor').innerText = "";
                loop();
            } catch (e) {
                alert("Mic Error: " + e);
            }
        }

        function loop() {
            if (!isListening) return;
            requestAnimationFrame(loop);

            const bufferLength = analyser.frequencyBinCount;
            const dataArray = new Uint8Array(bufferLength);
            analyser.getByteFrequencyData(dataArray);

            // 1. Find Loudest Frequency
            let maxVal = 0;
            let maxIndex = 0;
            for (let i = 0; i < bufferLength; i++) {
                if (dataArray[i] > maxVal) {
                    maxVal = dataArray[i];
                    maxIndex = i;
                }
            }

            // 2. Calculate Frequency in Hz
            const frequency = maxIndex * (audioCtx.sampleRate / analyser.fftSize);

            // 3. Noise Gate (Ignore quiet sounds)
            if (maxVal < 150) return; 

            // 4. Decode Logic
            document.getElementById('debug').innerText = `Heard: ${Math.round(frequency)} Hz`;

            // Check for Handshake
            if (Math.abs(frequency - HANDSHAKE_FREQ) < 100) {
                if (messageBuffer !== "") {
                     // New message starting, clear old
                     messageBuffer = "";
                     document.getElementById('monitor').innerText = "[RECEIVING...]";
                }
                return;
            }

            // Check for End
            if (Math.abs(frequency - END_FREQ) < 100) {
                // document.getElementById('monitor').innerText += " [END]";
                return;
            }

            // Check for Letters
            // Formula: Freq = Base + (Index * Step)
            // Index = (Freq - Base) / Step
            let rawIndex = (frequency - BASE_FREQ) / STEP_FREQ;
            let index = Math.round(rawIndex);
            
            // Validate Index (0 to 26)
            if (index >= 0 && index <= 27) {
                // Check if the frequency is close enough to the "perfect" center frequency
                let perfectFreq = BASE_FREQ + (index * STEP_FREQ);
                if (Math.abs(frequency - perfectFreq) < TOLERANCE) {
                    
                    let char = getCharFromIndex(index);
                    
                    // DEBOUNCE: We must hear the SAME character 5 frames in a row
                    if (char === lastChar) {
                        consecutiveHits++;
                    } else {
                        lastChar = char;
                        consecutiveHits = 0;
                    }

                    if (consecutiveHits === 5) { // Valid Confirmation
                        messageBuffer += char;
                        document.getElementById('monitor').innerText = messageBuffer;
                        consecutiveHits = 0; // Reset to prevent double typing
                        lastChar = ""; // Clear so we can type same letter again if needed (requires gap)
                    }
                }
            }
        }

        function getCharFromIndex(i) {
            if (i >= 0 && i <= 25) return String.fromCharCode(97 + i); // a-z
            if (i === 26) return " ";
            return "?";
        }
    </script>
</body>
</html>
